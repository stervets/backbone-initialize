!function(){var r,i,l,t,s,e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",a=e.length;this.BackbonePrepare=i=[],this.BackboneLaunchStatus={INIT:0,PREPARE:1,PREPARE_FAIL:2,READY:4},l=function(t){return Array.isArray(t)?t:t.split(",").map(function(t){return t.trim()})},s=function(t=16,n=""){for(;0<t--;)n+=e.charAt(Math.floor(Math.random()*a)),!t||t%4||(n+="-");return n},Backbone.BackboneInitializeNoWarnings=!1,r=function(){class t{warn(t){if(!Backbone.BackboneInitializeNoWarnings)return console.warn("Backbone-initialize warn: "+t)}getChild(t,n,i=this.entity){var e=t.shift();return null!=i[e]?t.length?this.getChild(t,n,i[e]):i[e]:(this.warn(e+` undefined (this.${n})`),null)}eventHandler(t){var n=this.handlers[t];return(...t)=>this.executeChain(n,t)}executeChain(i,e,a=this.entity,r,s){var h;return e=e||[],null==r&&(r=$.Deferred(),i=i.slice(),r.promise().defer=r),h=i.shift(),new Promise(async(t,n)=>{try{return await h.apply(a,e.concat(s||[])),i.length?this.executeChain(i,e,a,r,s):t.apply(a,e.concat(s||[]))}catch(t){return Backbone.BackboneInitializeNoWarnings||console.warn("Deferred chain fail",h),n.apply(a,e.concat(s||[]))}})}addListener(t,n,i,e){var a;return null==t._bbId&&(t._bbId=s()),a=t._bbId+"-"+n,null==this.handlers[a]&&(this.handlers[a]=[],this.entity.listenTo(t,n,this.eventHandler(a))),this.handlers[a].push(i.bind(e))}addHandler(t,s,h=this.entity){var a,n,i;if("object"==typeof t){for(a in n=[],t)i=t[a],n.push(this.addHandler(a,i,h));return n}if("object"!=typeof s||Array.isArray(s))return"string"==typeof s&&(s=l(s)),s=(s=Array.isArray(s)?s:[s]).slice(),"_"===t[0]&&(t=s.shift()),l(t).forEach(a=>{var r=h,t=a.split(".");if(a=t.pop(),!t.length||(r=this.getChild(t,t.join("."),r)))return s.forEach(t=>{var n,i=!1,e=this.entity;if("string"==typeof t){if(t=(n=(i=t).split(".")).pop(),!(e=n.length?this.getChild(n,i):this.entity))return;t=e[t]}return"function"==typeof t?this.addListener(r,a,t,e):this.warn(`Can't find handler for "${a}"`+(i?`: "${i}"`:""))})});l(t).forEach(t=>{var n,i,e;if(n=this.getChild(t.split("."),t,h)){for(a in i=[],s)e=s[a],i.push(this.addHandler(a,e,n));return i}return this.warn(`Can't append handlers to ${t} cause child not found`)})}addHandlers(){if(null!=this.entity.handlers&&!this.entity.disableHandlers)return this.addHandler(this.entity.handlers)}launch(t,...n){return null!=t&&this.addHandlers(),this.entity.launchStatus=BackboneLaunchStatus.READY,this.entity.trigger("launch",...n)}prepareAndLaunch(t){var n;return this.entity.firstLaunch=null!=this.prepares,(i.length||Array.isArray(this.entity.prepare))&&(null==this.prepares&&((n=this.entity).prepare||(n.prepare=[]),this.entity.prepare=i.concat(this.entity.prepare),this.prepares=this.entity.prepare.map(t=>{var n="function"==typeof t?t:this.entity[t];return"function"!=typeof n&&(this.warn(`Prepare item ${t} isn't function`),n=$.noop),n})),this.prepares.length)?(this.entity.launchStatus=BackboneLaunchStatus.PREPARE,this.entity.promise=this.executeChain(this.prepares,t),this.entity.promise.then(()=>this.launch(this.entity.firstLaunch,...t)).catch(()=>{if(Backbone.BackboneInitializeNoWarnings||console.warn("Backbone initialize prepares fail: ",this.prepares),this.entity.launchStatus=BackboneLaunchStatus.PREPARE_FAIL,"function"==typeof this.entity.onLaunchFail)return this.entity.onLaunchFail(...t)}),this.entity.promise):this.launch(this.entity.firstLaunch,...t)}constructor(t){var n,i,e;if(this.entity=t,null==this.entity.noBind)for(i in e=this.entity)"function"==typeof(n=e[i])&&(this.entity[i]=n.bind(this.entity));this.entity.addHandler=this.addHandler.bind(this),this.entity.executeChain=this.executeChain.bind(this),this.handlers={},this.entity.launchStatus=BackboneLaunchStatus.INIT}}return t.prototype.handlers=null,t.prototype.entity=null,t.prototype.prepares=null,t}.call(this),t=function(...t){var n,i,e,a=this.options;if(null==a&&(a=t[1]),"string"==typeof this.prepare&&(this.prepare=l(this.prepare)),"object"==typeof this.handlers||null!=(null!=a?a.attach:void 0)||"function"==typeof this.launch||Array.isArray(this.prepare)){if(this._bbInitialize=new r(this),"function"==typeof this.launch&&this.addHandler("launch",this.launch),null!=(null!=a?a.attach:void 0))for(n in e=a.attach)i=e[n],this[n]=i;return this.relaunch=()=>this._bbInitialize.prepareAndLaunch(t),this.relaunch()}},Backbone.Model.prototype.initialize=t,Backbone.Collection.prototype.initialize=t,Backbone.View.prototype.initialize=t,null!=Backbone.NestedModel&&(Backbone.NestedModel.prototype.initialize=t),null!=Backbone.Layout&&(Backbone.Layout.prototype.initialize=t),"undefined"!=typeof Marionette&&null!==Marionette&&(Marionette.Object.prototype.initialize=t)}.call(this);